- name: Create /var/lib/kubernetes dir
  file:
    path: /var/lib/kubernetes
    state: directory

- name: Copy controlplane CSR configs
  template:
    src: "{{ item }}.j2"
    dest: "/var/lib/kubernetes/{{ item }}"
  loop:
    - kube-controller-manager-csr.json
    - kube-scheduler-csr.json
    - kubernetes-csr.json

- name: Generate kube-controller-manager cert and key
  shell:
    cmd: >
      cfssl gencert -ca=ca.pem -ca-key=ca-key.pem 
      -config=ca-config.json -profile=kubernetes
      kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager
    chdir: /var/lib/kubernetes
    creates: /var/lib/kubernetes/kube-controller-manager.pem

- name: Generate kube-scheduler cert and key
  shell:
    cmd: >
      cfssl gencert -ca=ca.pem -ca-key=ca-key.pem
      -config=ca-config.json -profile=kubernetes 
      kube-scheduler-csr.json | cfssljson -bare kube-scheduler
    chdir: /var/lib/kubernetes
    creates: /var/lib/kubernetes/kube-scheduler.pem

- name: Generate kube-api-server cert and key
  shell:
    cmd: >
      cfssl gencert -ca=ca.pem -ca-key=ca-key.pem
      -config=ca-config.json
      "-hostname={{ ansible_default_ipv4.address }},{{ ansible_hostname }},{{ k8s_loadbalancer }}"
      -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes
    chdir: /var/lib/kubernetes
    creates: /var/lib/kubernetes/kubernetes.pem

- name: Generate service-account cert and key
  shell:
    cmd: >
      cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json
      -profile=kubernetes service-account-csr.json | cfssljson -bare service-account
    chdir: /var/lib/kubernetes
    creates: /var/lib/kubernetes/service-account.pem